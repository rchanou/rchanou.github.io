<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta charset="utf-8" />
    <title>Pole Position</title>

    <script src="../js/phantomjs-bind-polyfill.js"></script>
    <script src="../js/handlebars-latest.js"></script>
    <script src="../js/jquery.min.js"></script>
    <script src="../js/d3.js"></script>
    <script src="../js/c3.js"></script>

    <script src="../js/zutil.debug.js"></script>
    <script>
        // zUtil setup
        var z = new zUtil({
            useArrayExtensions: true,
            useNumberExtensions: true,
            useObjectExtensions: true,
            defaultLogger: console
        });
        var log = z.log;
        var assert = z.assert;
        var parameters = z.location.parameters;
    </script>
    <script src="../js/clubspeed-classes-api.js"></script>

    <link href='../css/open-sans.css' rel='stylesheet' type='text/css'>
    <link href='../css/c3.css' rel='stylesheet' type='text/css'>
    <style type="text/css">

        /* elements */

        html, body {
            font-family: Arial, Helvetica, sans-serif;
            height: 100%;
            min-height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            /*text-shadow: 1px 1px 1px rgba(0,0,0,0.04);*/
            /*-webkit-font-smoothing: antialiased;*/
        }
        html, body :hover {
            cursor: default;
        }
        #wrapper {
            width: 8.5in;
            height: 5.5in;
        }
        .speedSheetBody {
            width: 50%;
            height: auto;
        }
        #speedSheetHeaderLeft {
            height: 1.14in;
            width: 100%;
        }
        #speedSheetHeaderRight {
            height: 0.5in;
            width: 100%;
            background-color: transparent;
        }
        #speedSheetContentLeft {
            margin-left: 0.5in;
        }
        #speedSheetContentRight {
            width: 4.25in;
            height: 80%;
            margin-right: 1in;
        }
        .speedSheetContent {
            height: 4.25in;
            width: 100%;
            background-color: orange;
        }
        .speedSheetFooter {
            position: absolute;
            top: 5.1in;
            bottom: 5.5in;
            left: 0;
            right: 8.5in;
            height: 0.4in;
            width: 8.5in;
            background-color: transparent;
        }
        .driverHeader {
            height: 12px;
            margin-right: 9px;
        }
        .driverHeaderText {
            font-weight: bold;
            font-size: 10px;
            margin-left: 0.2in;
        }
        .driverRow {
            height: 11px;
            font-size: 9px;
            width: 3in;
        }
        .infoColLeft {
            font-weight: bold;
            margin-left: 0.5in;
            width: 1in;
        }
        .infoColRight {
            margin-right: 0.5in;
        }
        #lapsChart {
            height: 2.4in;
        }
        .spacing {
            background: transparent;
            height: 0.02in;
            background-image: -webkit-linear-gradient(left, rgba(0,0,0,0), rgba(0,0,0,0.75), rgba(0,0,0,0)); 
            background-image:    -moz-linear-gradient(left, rgba(0,0,0,0), rgba(0,0,0,0.75), rgba(0,0,0,0)); 
            background-image:     -ms-linear-gradient(left, rgba(0,0,0,0), rgba(0,0,0,0.75), rgba(0,0,0,0)); 
            background-image:      -o-linear-gradient(left, rgba(0,0,0,0), rgba(0,0,0,0.75), rgba(0,0,0,0)); 
            margin-top: 0.03in;
            margin-bottom: 0.07in;
        }
        .isCurrentRacer {
            background-color: black;
            color: gold;
        }
        .resultsInfo {
            height: 0.8in;
        }
        .resultsHeader {
            height: 20%;
            margin-right: 9px;
        }
        .resultsHeaderText {
            font-weight: bold;
            font-size: 10px;
            margin-left: 0.2in;
        }
        .resultsGrid {
            height: 80%;
        }
        .resultsRow {
            width: 100%;
            height: 16.67%;
            font-size: 9px;
        }
        .bestRow {
            width: 50%;
            height: 16%;
            font-size: 9px;
        }
        .resultsColLeft {
            margin-left: 0.1in;
            width: 1in;
        }
        .resultsColRight {
            margin-right: 0.1in;
        }

        /* helpers */

        .lFloat {
            float: left;
        }
        .rFloat {
            float: right;
        }
        .padLeft5 {
            padding-left: 5vmin;
        }
        .centerText {
            text-align: center;
        }
        .uppercase {
            text-transform: uppercase;
        }
        .italic {
            font-style: italic;
        }
        .hidden {
            visibility: hidden;
        }
        .visible {
            visibility: visible;
        }
        .hLeft {
            text-align: left;
        }
        .hCenter {
            text-align: center;
        }
        .hRight {
            text-align: right;
        }
        .vMiddle {
            vertical-align: middle;
        }
        .vMiddle::before {
            content: "";
            display: inline-block;
            height: 100%;
            vertical-align: middle;
        }
        .vBottom {
            vertical-align: text-bottom;
        }
        .vBottom::before {
            content: "";
            display: inline-block;
            height: 100%;
            vertical-align: text-bottom;
        }
        .fill {
            height: 100%;
            width: 100%;
        }
        .truncate {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>
<script>

    function getInternetExplorerVersion() {
        var rv = -1; // Return value assumes failure.
        if (navigator.appName == 'Microsoft Internet Explorer') { 
            // check for any IE < 11
            var ua = navigator.userAgent;
            var re  = new RegExp("MSIE ([0-9]{1,}[\.0-9]{0,})");
            if (re.exec(ua) != null) {
                rv = parseFloat( RegExp.$1 );
            }
        }
        else if (navigator.appName == 'Netscape') {
            // check for IE11, because IE11 is stupid
            var ua = navigator.userAgent;
            var re  = new RegExp("Trident/.*rv:([0-9]{1,}[\.0-9]{0,})");
            if (re.exec(ua) != null) {
                rv = parseFloat( RegExp.$1 );
            }
        }
        return rv;
    }

    function browserIsC3Compatible() {
        var ieVersion = getInternetExplorerVersion();
        if (ieVersion > 10 || ieVersion === -1) {
            // IE version greater than 10, or not using IE
            return true;
        }
        return false;
    }

    // main script execution

    // set up api call url information -- default to using ekwigan when running on either file:/// or localhost for testing purposes
    var h, apiRootUrl = ((!(h = document.location.hostname) || h == "localhost") ? 'https://pprlongisland.clubspeedtiming.com' : (window.location.origin || (window.location.protocol + "//" + window.location.host))) + "/api/index.php/";
    var api = new clubspeed.classes.ApiService({
        url: apiRootUrl,
        key: 'cs-dev',
    });
    var isC3Compatible = browserIsC3Compatible();

    // var heatNumber = parameters.HeatNo || 900;

    function getData() {
        var deferred = [];

        deferred.push(api.getRaceDetails(parameters.HeatNo).then(function(data) {
            // mutate the data here, not later
            var r = data.race;
            r.racers = data.race.racers
                    .innerJoin(data.scoreboard) // join scoreboard to racers
                    .on(function(x, y) { return x.id === y.racer_id; }) // on racers.id == scoreboard.racer_id
                    .orderBy(function(x) { return x.finish_position; }) // order by joined_object.finish_position (originally from scoreboard)
                    .map(function(x) {
                        x.laps = x.laps // alter the joined_object.laps array
                            .where(function(y) { return z.convert(y.lap_number, z.types.number) !== 0}) // chop off any laps where lap_number is 0
                            .orderBy(function(y) { return y.lap_number; }); // ensure that the laps are in order
                        return x;
                    });
            r.currentRacer = r.racers.first(function(x) { return x.id === parameters.CustID; }); // get a pointer to the currentRacer in the racers list
            return r; // pipe the data back as the deferred resolution
        }));

        deferred.push(api.getTopTimes("week"));

        return deferred;
    }

    function setupHandlebars() {
        Handlebars.registerHelper('inc', function(value, options) {
            return parseInt(value) + 1;
        });
        Handlebars.registerHelper('isCurrentRacer', function(index, options) {
            return z.equals(options.data.root.racers[parseInt(index)], options.data.root.currentRacer) ? "isCurrentRacer" : "";
        });
    }
    
    function getHtml() {
        var d = new Date();
        var currentDate = (d.getMonth() + 1) + "/" + d.getDate() + "/" + d.getFullYear();

        var positionChartHtml = '';
        if (isC3Compatible) {
            // use c3 to directly generate the chart, c3 is available
            positionChartHtml = '           <div id="lapsChart"></div>';
        }
        else {
            // use external phantomjs image creation for the chart, and include the image on the page
            positionChartHtml = '           <img src="http://pprlongisland.clubspeedtiming.com/api/shot/shot.php?url=pprlongisland.clubspeedtiming.com%2Fapi%2Fspeed-sheets%2Fposition-graph.html%3FHeatNo%3D' + parameters.HeatNo + '%26CustID%3D' + parameters.CustID + '&w=480&h=230&rand=Math.random()" />';
        }

        return '' +
                '<div id="wrapper" style="background-image:url({{backgroundUrl}}); background-repeat: no-repeat; background-position: center center; background-size: cover;">'
            +   '   <div class="speedSheetBody lFloat">'
            +   '       <div id="speedSheetHeaderLeft">'
            +   '           <div id="speedSheetHeaderLeftText" class="vMiddle hCenter fill"></div>'
            +   '       </div>'
            +   '       <div id="speedSheetContentLeft">'
            +   '           <div class="driverInfo">'
            +   '               <div class="driverHeader"><div class="driverHeaderText vMiddle">Driver Name: {{currentRacer.first_name}} {{currentRacer.last_name}} ({{currentRacer.nickname}})</div></div>'
            +   '               <div class="driverRow">'
            +   '                   <div class="infoColLeft vBottom hLeft lFloat">Date:</div>'
            +   '                   <div class="infoColRight vBottom hRight rFloat">' + currentDate + '</div>'
            +   '               </div>'
            +   '               <div class="driverRow">'
            +   '                   <div class="infoColLeft vBottom hLeft lFloat">Visits:</div>'
            +   '                   <div class="infoColRight vBottom hRight rFloat">{{currentRacer.total_visits}}</div>'
            +   '               </div>'
            +   '               <div class="driverRow">'
            +   '                   <div class="infoColLeft vBottom hLeft lFloat">Races:</div>'
            +   '                   <div class="infoColRight vBottom hRight rFloat">{{currentRacer.total_races}}</div>'
            +   '               </div>'
            +   '               <div class="driverRow">'
            +   '                   <div class="infoColLeft vBottom hLeft lFloat">ProSkill:</div>'
            +   '                   <div class="infoColRight vBottom hRight rFloat">{{currentRacer.rpm}}</div>'
            +   '               </div>'
            +   '           </div>'
            +   '           <div class="spacing"></div>'
            +   '           <div class="raceInfo">'
            +   '               <div class="driverHeader"><div class="driverHeaderText vMiddle">Race Info</div></div>'
            +   '               <div class="driverRow">'
            +   '                   <div class="infoColLeft vBottom hLeft lFloat">Track Name:</div>'
            +   '                   <div class="infoColRight vBottom hRight rFloat">{{track}}</div>'
            +   '               </div>'
            +   '               <div class="driverRow">'
            +   '                   <div class="infoColLeft vBottom hLeft lFloat">Race Name:</div>'
            +   '                   <div class="infoColRight vBottom hRight rFloat">{{race_name}}</div>'
            +   '               </div>'
            +   '               <div class="driverRow">'
            +   '                   <div class="infoColLeft vBottom hLeft lFloat">Race Format:</div>'
            +   '                   <div class="infoColRight vBottom hRight rFloat">{{win_by}}</div>'
            +   '               </div>'
            +   '           </div>'
            +   '           <div class="spacing"></div>'
            +   '           <div class="resultsInfo">'
            +   '               <div class="resultsHeader"><div class="resultsHeaderText vMiddle">Race Results</div></div>'
            +   '               <div class="resultsGrid">'
            +   '                   {{#each racers}}'
            +   '                       <div class="bestRow lFloat">'
            +   '                           <div class="resultsColLeft truncate lFloat vMiddle hLeft">{{inc @index}}. {{nickname}}</div>'
            +   '                           <div class="resultsColRight rFloat vMiddle hLeft">{{fastest_lap_time}}</div>'
            +   '                       </div>'
            +   '                   {{/each}}'
            +   '               </div>'
            +   '           </div>'
            +   '           <div class="spacing"></div>'
            +   '           <div class="resultsInfo">'
            +   '               <div class="resultsHeader"><div class="resultsHeaderText vMiddle">Best Lap this Week</div></div>'
            +   '               <div class="resultsGrid">'
            +   '                   {{#each fastest}}'
            +   '                       <div class="bestRow lFloat">'
            +   '                           <div class="resultsColLeft lFloat vMiddle hLeft truncate">{{inc @index}}. {{nickname}}</div>'
            +   '                           <div class="resultsColRight rFloat vMiddle hLeft">{{lap_time}}</div>'
            +   '                       </div>'
            +   '                   {{/each}}'
            +   '               </div>'
            +   '           </div>'
            +   '       </div>'
            +   '   </div>'
            +   '   <div class="speedSheetBody lFloat">'
            +   '       <div id="speedSheetHeaderRight">'
            +   '           <div id="speedSheetHeaderRightText" class="vMiddle hCenter fill"></div>'
            +   '       </div>'
            +   '       <div id="speedSheetContentRight">'
            +               positionChartHtml
            +   '       </div>'
            +   '   </div>'
            +   '   <div class="speedSheetFooter">'
            +   '       <div class="speedSheetFooterText vMiddle hCenter fill"></div>'
            +   '   </div>'
            +   '</div>';
    }

    function buildPage(html, data) {
        var template = Handlebars.compile(html);
        var output = template(data);
        $(output).appendTo("body");
    }

    function truncateStr(str, len, append) {
        if (!z.check.isNumber(len))
            return str;
        if (str.length <= len)
            return str;
        if (!z.check.exists(append))
            append = "";
        len = len - append.length;
        return str.slice(0, len) + append;
    }

    /**
        function buildCharts

        To be used with inline c3 chart creation from c3.js and d3.min.js
    */
    function buildCharts(data) {
        var chartColumns = [];
        var nickname = truncateStr(data.racers[0].nickname, 18, "...");
        chartColumns.push([nickname].concat(data.racers[0].laps.select(function(x) { return x.lap_time; })));
        var currentRacerFinishPosition = z.convert(data.currentRacer.finish_position, z.types.number);
        if (currentRacerFinishPosition !== 1) {
            var currentRacer = data.racers[currentRacerFinishPosition-1];
            nickname = truncateStr(currentRacer.nickname, 18, "...");
            chartColumns.push([nickname].concat(currentRacer.laps.select(function(x) { return x.lap_time; })));
        }

        log(data);
        log(chartColumns);

        var lapsChart = c3.generate({
            bindto: "#lapsChart",
            data: {
                columns: chartColumns
            },
            type: 'line',
            axis: {
                x: {
                    label: "Lap Number",
                    tick: {
                        format: function(x) { return x + 1; }
                    }
                },
                y: {
                    label: "Lap Time"
                }
            },
            grid: {
                x: {
                    show: true
                },
                y: {
                    show: true
                }
            }
        });
    }

    function getWhenData() {
        var data = {};
        z.forEach(Array.prototype.slice.call(arguments), function(val, key) { data.extend(val); });
        return data;
    }

    function loadPage() {
        setupHandlebars();
        $.when.apply($, getData()).then(function() {
            var data = getWhenData.apply(this, arguments).extend(parameters);
            log.debug(data);
            buildPage(getHtml(), data);
            log("isC3Compatible:" + isC3Compatible);
            if (isC3Compatible) {
                buildCharts(data); // to be used with inline c3 chart creation from c3.js and d3.min.js
            }
        });
    }
    loadPage();

</script>
</body>
</html>