<!DOCTYPE HTML>
<html>
<head>
  <title>Top ProSkill</title>
    <script src ="../js/handlebars-latest.js"></script>
    <script src="../js/jquery.min.js"></script>
    <script src="../js/zutil.min.js"></script>
    <link href='../css/open-sans.css' rel='stylesheet' type='text/css'>
    <style type="text/css">

        /* elements */

        html, body {
            font-family: 'Open Sans', sans-serif;
            height: 100%;
            min-height: 100%;
            margin: 0;
            background-color: #000000;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.04);
            -webkit-font-smoothing: antialiased;
        }
        html, body :hover {
            cursor: none;
        }
        #wrapper {
            min-height: 100%;
            height: 100%;
            width: 100%;
        }
        #headerSpacing {
            height: 1.5vh;
            background: transparent;
        }
        #headerWrapper {
            margin-top: 0;
            margin-bottom: 0;
            margin-left: 20vw;
            margin-right: 20vw;
            width: 60vw;
            height: 18.5vh;
            color: #414141;
            opacity: 0.90;
        }
        #headerWrapper .headerText {
            font-size: 4.6vh;
            font-weight: bold;
            color: black;
            height:100%;
        }
        #headerWrapper .headerText2 {
            font-size: 2.8vh;
            font-weight: bold;
            color: black;
            height:100%;
        }
        #headerTop {
            height: 50%;
            width: 100%;
            text-align: center;
            background: linear-gradient(to top right, #FFFFFF, #C9C9C9);
            z-index: 2;
            position: relative;
            border: 1px black solid;
        }
        #headerBottom {
            height: 50%;
            width: 100%;
            background: linear-gradient(to top right, #FFFFFF, #C9C9C9);
            z-index: 1;
            margin-top: -1vh;
            position: relative;
            border: 1px black solid;
        }
        #headerBottomLeft {
            width: 50%;
            height: 100%;
            float: left;
            text-align: center;
        }
        #headerBottomRight {
            width: 50%;
            height: 100%;
            float:left;
        }
        #headerBottomRight .headerText2 {
            width: 48%; /* for spacing */
            float: left;
            text-align: right;
        }
        #headerBottomRight .headerImg {
            width: 50%;
            height: 100%;
            float: right;
        }
        #clubSpeedLogo {
            vertical-align: middle;
            width: 100%;
            margin: 0 auto;
            max-width: 300px;
            max-height: 52px;
        }
        #results {
            margin-top: 0;
            margin-bottom: 0;
            margin-left: 2vw;
            margin-right: 2vw;
            height: 79vh;
            width: 96vw;
            opacity: 0.90;
        }
        #results .racer {
            width: 100%;
            height: 100%;
            height: 7.4vh;
            /*margin-top: 0.4vh;*/
            margin-left: 2vw;
            margin-right: 4vw;
        }
        #results .racer div {
            float: left;
            height: 100%;
        }
        #results .racer .racerText {
            width: 100%;
            height: 100%;
            font-weight: bold;
            font-size: 3.8vh;
        }
        #results .racer .position {
            width: 10%;
        }
        #results .racer .nickname {
            width: 70%;
        }
        #results .racer .lapTime {
            width: 17%;
        }
        .racerTextWrapper {
            margin-right: -6px; /* hackish css to get the parallelograms to overlap smoothly */
        }
        #results .firstPlace .racerTextWrapper {
            background: linear-gradient(to top right, #DAA520, #F5F5F5); /* goldenrod to whitesmoke */
            color: black;
        }
        #results .secondPlace .racerTextWrapper {
            background: linear-gradient(to top right, #C0C0C0, #F5F5F5); /* silver to whitesmoke */
            color: black;
        }
        #results .thirdPlace .racerTextWrapper {
            background: linear-gradient(to top right, #8C7853, #F5F5F5); /* bronze to whitesmoke */
            color: black;
        }
        #results .otherPlace .racerTextWrapper {
            background: linear-gradient(to top right, #000000, #A9A9A9); /* black to darkgrey */
            color: white;
        }

        /* helpers */

        /* vertical text alignment helper */
        .headerText::before, .headerText2::before, .headerImg::before, .racerText::before {
            content: "";
            display: inline-block;
            height: 100%;
            vertical-align: middle;
        }
        .shadows {
            text-shadow: 0 0.175vmin 0 rgba(201,201,201,1),
                0 0.2625vmin 0 rgba(187,187,187,1),
                0 0.35vmin 0 rgba(185,185,185,1),
                0 0.4375vmin 0 rgba(170,170,170,1),
                0 0.375vmin 0.175vmin rgba(0,0,0,.1),
                0 0 0.4375vmin rgba(0,0,0,.1),
                0 0.0875vmin 0.2625vmin rgba(0,0,0,.3),
                0 0.2625vmin 0.4375vmin rgba(0,0,0,.2),
                0 0.4375vmin 0.875vmin rgba(0,0,0,.25),
                0 0.875vmin 0.875vmin rgba(0,0,0,.2),
                0 1.75vmin 1.75vmin rgba(0,0,0,.15);
        }
        .glowWhiteShadows {
            text-shadow: 0 0 1vmin rgba(230,230,230,0.7),
                0 0.175vmin 0 rgba(201,201,201,1),
                0 0.2625vmin 0 rgba(187,187,187,1),
                0 0.35vmin 0 rgba(185,185,185,1),
                0 0.4375vmin 0 rgba(170,170,170,1),
                0 0.375vmin 0.175vmin rgba(0,0,0,.1),
                0 0 0.4375vmin rgba(0,0,0,.1),
                0 0.0875vmin 0.2625vmin rgba(0,0,0,.3),
                0 0.2625vmin 0.4375vmin rgba(0,0,0,.2),
                0 0.4375vmin 0.875vmin rgba(0,0,0,.25),
                0 0.875vmin 0.875vmin rgba(0,0,0,.2),
                0 1.75vmin 1.75vmin rgba(0,0,0,.15);
        }
        .padLeft5 {
            padding-left: 5vmin;
        }
        .centerText {
            text-align: center;
        }
        .uppercase {
            text-transform: uppercase;
        }
        .italic {
            font-style: italic;
        }
        .parallelogram {
            -webkit-transform: skew(335deg);
            -moz-transform: skew(335deg);
            -o-transform: skew(335deg);
            -transform: skew(335deg);
            -webkit-border-radius: 5px 5px 5px 5px;
            -moz-border-radius: 5px 5px 5px 5px;
            border-radius: 5px 5px 5px 5px;
            height: 100%;
            width: 100%;
        }
        .unskew {
            -webkit-transform: skew(25deg);
            -moz-transform: skew(25deg);
            -o-transform: skew(25deg);
            width: 100%;
            height: 100%;
        }
        .hidden {
            visibility: hidden;
        }
        .visible {
            visibility: visible;
        }

        /* animations */

        @-webkit-keyframes fadeInDown {
            0% {
                opacity: 0;
                -webkit-transform: translateY(-8vh);
                transform: translateY(-8vh);
            }
            100% {
                opacity: 1;
                -webkit-transform: translateY(0);
                transform: translateY(0);
            }
        }
        @keyframes fadeInDown {
            0% {
                opacity: 0;
                -webkit-transform: translateY(-8vh);
                -ms-transform: translateY(-8vh);
                transform: translateY(-8vh);
            }
            100% {
                opacity: 1;
                -webkit-transform: translateY(0);
                -ms-transform: translateY(0);
                transform: translateY(0);
            }
        }
        .fadeInDown {
            -webkit-animation-name: fadeInDown;
            -webkit-animation-iteration-count: 1;
            -webkit-animation-timing-function: ease-in;
            -webkit-animation-duration: 0.5s;

            animation-name: fadeInDown;
            animation-iteration-count: 1;
            animation-timing-function: ease-in;
            animation-duration: 0.5s;
        }
        @-webkit-keyframes fadeInLeft {
            0% {
                opacity: 0;
                -webkit-transform: translateX(-8vw);
                transform: translateX(-8vw);
            }
            100% {
                opacity: 1;
                -webkit-transform: translateX(0);
                transform: translateX(0);
            }
        }
        @keyframes fadeInLeft {
            0% {
                opacity: 0;
                -webkit-transform: translateX(-8vw);
                -ms-transform: translateX(-8vw);
                transform: translateX(-8vw);
            }
            100% {
                opacity: 1;
                -webkit-transform: translateX(0);
                -ms-transform: translateX(0);
                transform: translateX(0);
            }
        }
        .fadeInLeft {
            -webkit-animation-name: fadeInLeft;
            -webkit-animation-iteration-count: 1;
            -webkit-animation-timing-function: ease-in;
            -webkit-animation-duration: 0.5s;

            animation-name: fadeInLeft;
            animation-iteration-count: 1;
            animation-timing-function: ease-in;
            animation-duration: 0.5s;
        }
    </style>
</head>
<body>
<script>
    var z = new zUtil({
        useArrayExtensions: true,
        useNumberExtensions: true,
        useObjectExtensions: true,
        defaultLogger: console
    });
    var log = z.log;
    var assert = z.assert;
    var sw = z.sw;
    var parameters = z.location.parameters;
    var data = {}; // for use with handlebars


    /**
        API and parameter query string helpers
    */ 

    // set up api call url information
    var apiRootUrl;
    if (!document.location.hostname || document.location.hostname == "localhost") { // can be removed in production code -- just for testing
        apiRootUrl = 'https://ekwigan.clubspeedtiming.com';
    }
    else {
        apiRootUrl = window.location.origin || (window.location.protocol + "//" + window.location.host);
    }
    var apiRootPath = '/api/index.php';
    var apiTopRpmUrl = '/racers/toprpm.js';

    // create default queries to be applied to all api calls
    var apiDefaults = {
        // track: currentTrackId,
        key: 'cs-dev' // todo: replace with actual apiKey selection
    };
    function addDefaults(apiQueries) {
        return $.extend({}, apiQueries, apiDefaults);
    }

    // set up the api query parameters
    var apiTopRpmQueries = addDefaults({
        limit: parseInt(parameters.limit) || 10,
    });
    function buildUrl(api, queries) {
        // builds the api url based off of the originally defined root url, and the provided apiType
        return apiRootUrl 
            + apiRootPath
            + api
            + (queries ? "?" + $.param(queries) : "");
    }
    function handleSuccess(apiData, textStatus, xhr) {
        data.extend(apiData);
    }
    function handleError(xhr, textStatus, errorThrown) {
        log.error(xhr.status + ": " + errorThrown);
    }


    /**
        HTML and API data manipulators
    */

    function applyHtmlClass(elems, cssClasses, delay) {
        var currentDelay = 0;
        delay = delay || 0;
        if (z.check.isString(cssClasses)) {
            cssClasses = [cssClasses.split(",")].reduce(function(x) { return x.trim(); }); // convert a csv string to array
        }
        z.assert.isArray(cssClasses);
        if (elems) {
            if (elems.length) {
                for (var i = 0; i < elems.length; i++) {
                    (function(index) {
                        setTimeout(function() {
                            var elem = $(elems[index]);
                            for (var k = 0; k < cssClasses.length; k++) {
                                elem.addClass(cssClasses[k]);
                            }
                        }, delay*index);
                    })(i); // use an iife to maintain the correct index for setTimeout
                }
            }
        }
    }

    function applyAnimations() {
        // ensure that the delay is never longer than 2/3 of the slideTimeout, but dont go over 350ms
        // using 15000 as a default when parameters.slideTimeout is not available to match the default time selection from sp_admin
        var d, delay = (d = (+parameters.slideTimeout || 15000) / (data.racers.length * 1.5)) > 350 ? 350 : d;
        applyHtmlClass($('.racer'), ['fadeInDown', 'visible'], delay);
    }

    function localizeData(data) {
        var locale = z.location.locale; // make a copy so the computation is only done once
        if (z.check.exists(data) && z.check.isArray(data.racers)) {
            for (var i = 0; i < data.racers.length; i++) {
                data.racers[i].rpm = parseInt(data.racers[i].rpm).toLocaleString(locale);
            }
        }
    }

    function buildAndAppendHtml(templateHtml) {
        // build an array of deferred objects for api data collection
        var deferreds = [];

        // setup handlebars data object to be extended with api data
        data.extend(parameters, apiTopRpmQueries);

        // push the getJSON call for top RPM
        deferreds.push(
            $.ajax({
                url: buildUrl(apiTopRpmUrl, apiTopRpmQueries),
                type: "GET",
                dataType: "json",
                async: true
            })
            .done(handleSuccess)
            .fail(handleError)
        );

        // handle the final async call to use the built data object
        $.when.apply($, deferreds).then(function() {
            localizeData(data); // handle the timestamp alterations here(?)
            var template = Handlebars.compile(templateHtml); // compile the originally defined source
            var output = template(data); // attach the data so handlebars can interpret it
            $(output).appendTo("body"); // attach the interpreted/compiled source to the HTML
            if (z.convert(parameters.disableAnimations, z.types.boolean)) {
                $('.racer').addClass('visible');
            }
            else {
                applyAnimations();
            }
        });
    }

    /**
        Functions, data, and documentation for the end-user to modify as desired
    */

    //// --- example data object to be passed to HandleBars templating engine ---
    // data: {
    //     "locale": "en",
    //     "trackId": "1",
    //     "speedLevel": "1",
    //     "dateSpan": "month",
    //     "backgroundUrl": "./temp/white.jpg",
    //     "limit": "5",
    //     "racers": [
    //         {
    //             "id": "1017984",
    //             "name": {
    //                 "nickname": "josh",
    //                 "first": "Joshua",
    //                 "last": "Booth"
    //             },
    //             "rpm": "1,891",
    //             "created_at": "2013-09-12"
    //         },
    //         {
    //             "id": "1000467",
    //             "name": {
    //                 "nickname": "bennett81",
    //                 "first": "George",
    //                 "last": "Bennett"
    //             },
    //             "rpm": "1,888",
    //             "created_at": "2013-02-03"
    //         },
    //         {
    //             "id": "1019340",
    //             "name": {
    //                 "nickname": "philip c",
    //                 "first": "Philip",
    //                 "last": "Cunliffe"
    //             },
    //             "rpm": "1,741",
    //             "created_at": "2013-08-12"
    //         },
    //         {
    //             "id": "1002993",
    //             "name": {
    //                 "nickname": "simple jack",
    //                 "first": "Jack",
    //                 "last": "Ball"
    //             },
    //             "rpm": "1,700",
    //             "created_at": "2013-27-11"
    //         },
    //         {
    //             "id": "1009789",
    //             "name": {
    //                 "nickname": "MR. MARUSHIN",
    //                 "first": "Mike",
    //                 "last": "Davies"
    //             },
    //             "rpm": "1,697",
    //             "created_at": "2013-27-11"
    //         }
    //     ]
    // }

    Handlebars.registerHelper('getPlace', function(index, options) {
        switch (index) {
            case 0: return "firstPlace";
            case 1: return "secondPlace";
            case 2: return "thirdPlace";
            default: return "otherPlace";
        }
    });
    Handlebars.registerHelper('inc', function(value, options) {
        return parseInt(value) + 1;
    });
    Handlebars.registerHelper('getRacerHeight', function(options) {
        return (96 / options.data.root.racers.length);
    });
    Handlebars.registerHelper('getRacerFontSize', function(options) {
        return 2 + (100 / (options.data.root.racers.length * 5));
    });

    var src = '' +
            '<div id="wrapper" style="background-image:url({{backgroundUrl}}); background-repeat: no-repeat; background-position: center center; background-size: cover;">'
        +   '   <div id="headerSpacing"></div>'
        +   '   <div id="headerWrapper">'
        +   '       <div id="headerTop" class="parallelogram">'
        +   '           <div class="headerText unskew uppercase shadows">TOP PROSKILL RANKING</div>'
        +   '       </div>'
        +   '       <div id="headerBottom" class="parallelogram">'
        +   '           <div class="unskew">'
        +   '               <div id="headerBottomLeft">'
        +   '                   <div class="headerText2"></div>'
        +   '               </div>'
        +   '               <div id="headerBottomRight">'
        +   '                   <div class="headerText2 italic shadows">POWERED BY</div>'
        +   '                   <div class="headerImg"><img id="clubSpeedLogo" src="../img/clubspeed_full_logo_300.png" /></div>'
        +   '               </div>'
        +   '           </div>'
        +   '       </div>'
        +   '   </div>'
        +   '   <div id="results">'
        +   '       {{#each racers}}'
        +   '           <div class="racer hidden {{getPlace @index}}" style="height: {{getRacerHeight}}%; font-size: {{getRacerFontSize}}vh;">'
        +   '               <div class="racerTextWrapper position parallelogram centerText"><div class="racerText unskew">{{inc @index}}</div></div>'
        +   '               <div class="racerTextWrapper nickname parallelogram"><div class="racerText unskew padLeft5">{{name.nickname}}</div></div>'
        +   '               <div class="racerTextWrapper lapTime parallelogram centerText"><div class="racerText unskew">{{rpm}}</div></div>'
        +   '           </div>'
        +   '       {{/each}}'
        +   '   </div>'
        +   '</div>';

    buildAndAppendHtml(src); // call the previously defined function

    // code for the angularjs
    function receiveMessage(event) {
        // console.log(event);
        // console.log(event.origin);
        // console.log(event.data);
    }
    window.addEventListener("message", receiveMessage, false);

    // code for the slide js
    window.postMessage({
        slideComplete:true
    }, "*");

</script>
</body>
</html>